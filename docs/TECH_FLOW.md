# TECH_FLOW: Техническая логика работы бота
## 1. Общий процесс работы
Бот выполняет два основных сценария:

### **Проверка username**
1. Пользователь вводит username.
2. `handlers/check.py` принимает ввод и передаёт его в `services/check.py`.
3. `services/check.py` делает запрос к **Telegram API** (`get_chat`).
4. Если Telegram API возвращает ошибку `chat not found`, выполняется HTTP-запрос к fragment.com через `aiohttp`. ## ранее t.me API, перестало работать 
5. **Возвращаемые статусы**:
   - "Свободно"
   - "Занято"
   - "Невозможно определить"

### **Генерация username**
1. Пользователь вводит контекст (ключевые слова).
2. `handlers/generate.py` передаёт запрос в `services/generate.py`.
3. `services/generate.py` делает запрос в **OpenAI API** (`chat.completions.create`).
4. Полученный список username проверяется через `services/check.py` как в сценарии _проверка username_
5. Возвращается список доступных username.

## 2. Обзор обработчиков (handlers)
- `start.py` — обработка команды `/start`, приветствие.
- `check.py` — принимает username, передаёт в `services/check.py`.
- `generate.py` — принимает контекст, запрашивает генерацию username через OpenAI API, проверяет доступность.
- `help.py` — обработка команды `/help`, выдача справки.
- 'common.py'
- 'states.py'

## 3. Передача данных между модулями
- **`handlers`** — принимают ввод пользователя и передают в `services`.
- **`services`** — выполняют логику, взаимодействуют с API.
- **`keyboards`** — управляют кнопками взаимодействия.

## 4. Взаимодействие с API
### **Telegram API**
- **Метод:** `get_chat(@username)`
- **Результат:** Проверка существования username. Если `chat not found`, проверяется через t.me API.

### **t.me API** (веб-запрос)
- **Метод:** `aiohttp.get("https://t.me/{username}")`
- **Результат:** Анализ HTML-ответа:
  - **404** — username свободен.
  - **Если в тексте страницы есть 'tgme_page_title' или 'If you have Telegram, you can contact'** — username занят.
  - **Если в заголовке есть 'Telegram: Contact @{username}', но отсутствует 'tgme_page_title'** — username свободен.
  - **Если не найдено ни одного из этих признаков** — статус "Невозможно определить".

### **OpenAI API**
- **Метод:** `chat.completions.create`
- **Результат:** Генерация списка username по контексту.

## 5. Обработка ошибок
### **Ошибки проверки username**
- **Telegram API (`get_chat`) возвращает ошибку `chat not found`** → выполняется запрос к t.me API.
- **Telegram API возвращает ошибку, не содержащую 'chat not found'** → возвращается "Невозможно определить".
- **Ответ t.me API не содержит 404, 'tgme_page_title', 'If you have Telegram, you can contact' или 'Telegram: Contact @{username}' в заголовке** → возвращается "Невозможно определить".
- **Ошибка сети при запросе к t.me API** → возвращается "Невозможно определить".

### **Комментарии по логике t.me API**
Так как Telegram не предоставляет API для проверки username, бот использует обходной метод:
- Если сервер t.me возвращает **404**, значит username **свободен**.
- Если в HTML-ответе **есть `tgme_page_title` или `If you have Telegram, you can contact`**, значит username **занят**.
- Если в **заголовке страницы** есть `Telegram: Contact @{username}`, но отсутствует `tgme_page_title`, значит username **свободен**.
- Если **ничего из этого нет**, бот **не может определить статус username** и возвращает "Невозможно определить".

### **Ошибки генерации username**
- **Ошибки OpenAI API не передаются пользователю.**
- **Если OpenAI API не вернул данные, бот логирует предупреждение.**
- **Если сгенерированные username не соответствуют требованиям или заняты, бот не возвращает их.**

### **Ошибки валидации username**
- **Некорректный username** (неправильные символы, длина меньше 5 или больше 32) → бот отправляет сообщение с разъяснением.

Этот TECH_FLOW фиксирует основные моменты логики работы бота.


