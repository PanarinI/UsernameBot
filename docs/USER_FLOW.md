# User Flow для Telegram-бота (UsernameBot)

Ниже приведён подробный user flow, отражающий логику работы бота с учётом представленной структуры и содержимого файлов.

---

## 1. Точка входа и Главное Меню

- **Запуск бота:**  
  Пользователь отправляет команду **/start** (обработчик в `handlers/start.py` – код не приведён, но предполагается, что он выводит главное меню).

- **Результат:**  
  - Бот отправляет приветственное сообщение.
  - Прикрепляется inline-клавиатура из `keyboards/main_menu.py`, содержащая три кнопки:
    - **«Сгенерировать username»** (callback_data: `"generate"`)
    - **«Проверить username»** (callback_data: `"check"`)
    - **«Помощь»** (callback_data: `"help"`)

- **Общий механизм возврата:**  
  Обработчик в `handlers/common.py` перехватывает нажатие кнопки **«Назад в главное меню»** (callback_data: `"back_to_main"`) и отправляет сообщение с текстом «Вы вернулись в главное меню» с клавиатурой главного меню.

---

## 2. Режим Генерации Username

### 2.1. Инициация генерации

1. **Действие пользователя:**  
   В главном меню нажимается кнопка **«Сгенерировать username»** (callback_data: `"generate"`).

2. **Обработка (handlers/generate.py):**
   - Функция `cmd_generate_username` перехватывает callback `"generate"`.
   - Бот отправляет сообщение:
     > "Введите тему/контекст для генерации username:"
   - Устанавливается FSM-состояние:  
     `GenerateUsernameStates.waiting_for_context`

### 2.2. Ввод Контекста и Генерация

3. **Действие пользователя:**  
   Пользователь вводит текст, например:
   > "технологичный, современный, стартап"

4. **Обработка (handlers/generate.py):**
   - Обработчик `process_context_input` срабатывает, когда бот получает сообщение в состоянии `waiting_for_context`.
   - Извлекается контекст из сообщения.
   - Вызывается сервис:
     ```python
     await get_available_usernames(bot, context_text, n=config.AVAILABLE_USERNAME_COUNT)
     ```
   - **Что происходит внутри сервиса (services/generate.py):**
     - Функция `generate_usernames(context, n)` формирует prompt (на основе `config.PROMPT`) и отправляет запрос к OpenAI API.
     - Ответ API разбивается по запятым, производится очистка и фильтрация:
       - Каждое имя проверяется функцией `is_valid_username` (определённой в `handlers/check.py`).
     - Для каждого кандидата вызывается функция `check_username_availability(bot, username)` из `services/check.py`, которая:
       - Сначала пытается получить чат через `bot.get_chat("@username")`.
       - При возникновении ошибки анализирует её текст и, если необходимо, выполняет дополнительную проверку через HTTP-запрос к [t.me/username](https://t.me/username).
       - Возвращает статус: **"Свободно"**, **"Занято"** или **"Невозможно определить"**.
     - Собираются только те username, для которых статус равен **"Свободно"**.
     - Как только собрано нужное количество (определяемое в `config.AVAILABLE_USERNAME_COUNT`), функция возвращает список доступных вариантов.

5. **Вывод результата:**
   - Обработчик `process_context_input` отправляет пользователю сообщение вида:
     > "Вот сгенерированные для вас username по теме 'технологичный, современный, стартап':"
   - К сообщению прикрепляется inline-клавиатура, сформированная через функцию `generate_username_kb(usernames)` из `keyboards/generate.py`.
   - FSM-состояние сбрасывается через `await state.clear()`.

### 2.3. Дальнейшие действия в режиме генерации

6. **Навигация после генерации:**  
   Inline-клавиатура (из `keyboards/generate.py`) содержит кнопки:
   - **«Повторить генерацию»** – переводит пользователя обратно в состояние `waiting_for_context` для ввода нового описания.
   - **«Назад в главное меню»** – срабатывает общий обработчик (callback_data: `"back_to_main"`), возвращая пользователя в главное меню.

---

## 3. Режим Проверки Username

### 3.1. Инициация проверки

1. **Действие пользователя:**  
   Из главного меню нажимается кнопка **«Проверить username»** (callback_data: `"check"`).

2. **Обработка (handlers/check.py):**
   - Функция `cmd_check` перехватывает callback `"check"`.
   - Бот отправляет сообщение:
     > "Введите username для проверки (без @):"
   - Устанавливается FSM-состояние:  
     `CheckUsernameStates.waiting_for_username`

### 3.2. Ввод Username и Проверка

3. **Действие пользователя:**  
   Пользователь вводит, например:
   > "example_username"

4. **Обработка (handlers/check.py):**
   - Обработчик `check_username` срабатывает, когда бот получает сообщение в состоянии `waiting_for_username`.
   - Извлекается и очищается введённый username.
   - **Валидация:**  
     Функция `is_valid_username(username)` проверяет, соответствует ли формат:
     - Длина от 5 до 32 символов.
     - Разрешены латинские буквы, цифры и нижнее подчёркивание.
   - **Если имя некорректно:**  
     Бот отправляет сообщение с указаниями по правильному формату и просит повторить ввод.
   - **Если имя корректно:**
     - Вызывается сервис:
       ```python
       await check_username_availability(bot, username)
       ```
     - **Внутри функции проверки (services/check.py):**
       - Сначала вызывается `bot.get_chat("@username")` для проверки через Telegram API.
       - При возникновении ошибки анализируется её сообщение. Если ошибка содержит «chat not found», выполняется дополнительная проверка через HTTP-запрос к [t.me/username](https://t.me/username).
       - В итоге возвращается статус: **"Свободно"**, **"Занято"** или **"Невозможно определить"**.
   - В зависимости от результата бот отправляет сообщение:
     - Если **"Свободно":**
       > "✅ Имя @example_username свободно!"
     - Если **"Занято":**
       > "❌ Имя @example_username занято."
     - Если **"Невозможно определить":**
       > "⚠️ Не удалось определить доступность @example_username."
   - Прикрепляется inline-клавиатура из `keyboards/check.py`, содержащая кнопки:
     - **«Проверить другое имя»** – для повторного ввода (callback_data: `"check"`).
     - **«Назад в главное меню»** – для возврата в главное меню (callback_data: `"back_to_main"`).
   - FSM-состояние сбрасывается через `await state.clear()`.

### 3.3. Дальнейшие действия в режиме проверки

5. **Навигация после проверки:**  
   - Если пользователь выбирает **«Проверить другое имя»**, бот остаётся в режиме проверки и запрашивает ввод нового username.
   - Если выбирается **«Назад в главное меню»**, срабатывает общий обработчик возврата, и бот выводит главное меню.

---

## 4. Общие Моменты и Навигация

- **Кнопка «Назад в Главное Меню»:**  
  Реализована в `handlers/common.py` и используется во всех режимах (генерация, проверка, помощь). При её нажатии:
  - Вызывается `await query.answer()`.
  - (Опционально) происходит сброс FSM-состояния через `await state.clear()`.
  - Бот отправляет сообщение с текстом «Вы вернулись в главное меню» и прикрепляет клавиатуру главного меню из `keyboards/main_menu.py`.

- **Помощь:**  
  Хотя код для обработки команды **«Помощь»** не приведён, предполагается, что при выборе этой опции бот отправляет справочную информацию и клавиатуру с кнопкой возврата в главное меню.

---

## 5. Итоговый Пользовательский Сценарий (User Flow)

1. **Запуск и Главное Меню:**
   - Пользователь запускает бота командой **/start**.
   - Отображается главное меню с кнопками:
     - **Сгенерировать username**
     - **Проверить username**
     - **Помощь**

2. **Режим Генерации:**
   - Пользователь выбирает **«Сгенерировать username»**.
   - Бот запрашивает ввод темы/контекста для генерации.
   - Пользователь вводит контекст.
   - Бот через сервисы:
     - Генерирует набор вариантов username с помощью OpenAI API.
     - Проверяет доступность каждого варианта.
     - Фильтрует и возвращает список доступных username.
   - Результат отправляется с inline-клавиатурой:
     - **«Повторить генерацию»** – для нового ввода.
     - **«Назад в главное меню»** – для возврата.

3. **Режим Проверки:**
   - Пользователь выбирает **«Проверить username»**.
   - Бот запрашивает ввод username (без символа @).
   - Пользователь вводит username.
   - Бот проверяет корректность формата:
     - Если некорректно – отправляет сообщение с инструкциями.
     - Если корректно – проверяет доступность через Telegram API и веб-запрос.
   - Результат проверки отправляется с inline-клавиатурой:
     - **«Проверить другое имя»** – для повторного ввода.
     - **«Назад в главное меню»** – для возврата.

4. **Общий Механизм Возврата:**  
   Во всех режимах, при нажатии **«Назад в главное меню»**, пользователь возвращается в главное меню и может выбрать новый режим или получить помощь.

---

Эта схема user flow учитывает:
- Работу FSM (состояния ожидания ввода для генерации и проверки).
- Взаимодействие с OpenAI API для генерации вариантов.
- Многоступенчатую проверку доступности username.
- Единообразную навигацию с использованием inline-клавиатур.

